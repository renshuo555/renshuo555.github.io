---
layout: post
title: 计算机网络第4章 网络层(下)
date: 2017-9-18 08:53:18
categories: Network
tags: 计算机网络
author: renshuo
mathjax: true
typora-copy-images-to: pictures\networks\04
---

* content
{:toc}

《计算机网络(第七版)-谢希仁》 第4章 网络层(下)

<!--more-->

## 网际控制报文协议ICMP

为了更有效地转发IP数据报和提高交付成功的机会，在网际层使用了网际控制报文协议ICMP(Internet Control Message Protocol)。

![1505717833533](/pictures/networks/04/1505717833533.png)

### ICMP报文的种类

ICMP报文的种类有两种，即**ICMP差错报告报文**和**ICMP询问报文**。

![1505718400989](/pictures/networks/04/1505718400989.png)

### 应用举例

* 分组网间探测**PING(Packet InterNet Groper)**,用来测试两台主机之间的连通性
* 另一个非常有用的应用是**traceroute (这是UNIX操作系统中名字)**，它用来跟踪一个分 组从源点到终点的路径。**在Windows操作系统中这个命令是tracert**。

## 互联网的路由选择协议

### 几个基本概念

理想的路由算法应具有如下的一些特点：算法必须是正确和完整的；算法在计算上应简单；算法应能适应通信量和网络拓扑的变化；算法应具有稳定性；算法应是公平的；算法应是最佳的。

倘若从路由算法能否随网络的通信量或拓扑自适应地进行调整变化来划分，则只有两大类，即**静态路由选择策略**与**动态路由选择策略**。静态路由选择也叫做**非自适应路由选择**， 其特点是简单和开销较小，但不能及时适应网络状态的变化。对于很简单的小网络，完全可以采用静态路由选择，用人工配置每一条路由。动态路由选择也叫做**自适应路由选择**，其特 点是能较好地适应网络状态的变化，但实现起来较为复杂，开销也比较大。因此，**动态路由选择适用于较复杂的大网络**。

互联网釆用的路由选择协议主要是自适应的(即动态的)、分布式路由选择协议。

互联网釆用**分层次**的路由选择协议。

互联网就把路由选择协议划分为两大类：

* **内部网关协议IGP (Interior Gateway Protocol)**  即在一个自治系统内部使用的路由选择协议，而这与在互联网中的其他自治系统选用什么路由选择协议无关。目前这类路由选择协议使用得最多，如RIP和OSPF协议。
* **外部网关协议EGP (External Gateway Protocol)**  若源主机和目的主机处在不同的自治系统中(这两个自治系统可能使用不同的内部网关协议)，当数据报传到一个自治系统的边界时，就需要使用一种协议将路由选择信息传递到另一个自治系统中。这样的协议就是 外部网关协议EGP。目前使用最多的外部网关协议是BGP的版本4(BGP-4)。

自治系统之间的路由选择也叫做**域间路由选择(interdomain routing)**，而在自治系统内部 的路由选择叫做**域内路由选择(intradomain routing)**。

### 内部网关协议RIP

RIP协议最大的优点就是**实现简单，开销较小**。但RIP协议的缺点也较多。首先，RIP限制了网络的规模，它能使用的最大距离为15(16表示不可达)。其次，路由器之间交换的路由信息是路由器中的完整路由表，因而随着网络规模的扩大，开销也就增加。最后，“**坏消息传播得慢**”，使更新过程的收敛时间过长。因此，对于规模较大的网络就应当使 用下一节所述的OSPF协议。然而目前在规模较小的网络中，使用RIP协议的仍占多数。

### 内部网关协议OSPF

OSPF最主要的特征就是使用**分布式的链路状态协议(link state protocol)**，而不是像RIP那样的距离向量协议。

由于各路由器之间频繁地交换链路状态信息，因此所有的路由器最终都能建立一个**链路状态数据库(link-state database)**,这个数据库实际上就是全网的拓扑结构图。这个拓扑结构图在全网范围内是一致的(这称**为链路状态数据库的同步**)。

好处很多……

### 外部网关协议BGP

边界网关协议BGP只能是力求寻找一条能够到达目的网络且比较好的路由(不能兜圈子)，而**并非要寻找一条最佳路由**。BGP采用了**路径向量(path vector)路由选择协议**，它与距离向量协议(如RIP)和链路状态协议(如OSPF)都有很大的区别。

### 路由器的构成

![1505722074204](/pictures/networks/04/1505722074204.png)

![1505722166498](/pictures/networks/04/1505722166498.png)

![1505722179634](/pictures/networks/04/1505722179634.png)

![1505722241699](/pictures/networks/04/1505722241699.png)

## IPv6

### IPv6的基本首部

IPv6仍支持无连接的传送，但将协议数据单元PDU称为分组，而不是IPv4的数据报。

IPv6所引进的主要变化如下：

* 更大的地址空间。IPv6把地址从IPv4的32位增大到4倍，即增大到128位。
* 扩展的地址层次结构。
* 灵活的首部格式。IPv6数据报的首部和IPv4的并不兼容。IPv6定义了许多可选的 扩展首部，不仅可提供比IPv4更多的功能，而且还可提高路由器的处理效率。
* 改进的选项。IPv6允许数据报包含有选项的控制信息，因而可以包含一些新的选项。但IPv6的首部长度是固定的，其选项放在有效载荷中。
* 允许协议继续扩充。
* 支持即插即用(即自动配置)。因此IPv6不需要使用DHCP。
* 支持资源的预分配。
* IPv6首部改为8字节对齐(即首部长度必须是8字节的整数倍)。

IPv6数据报由两大部分组成，即**基本首部(base header)**和后面的**有效载荷(payload)**。有 效载荷也称为**净负荷**。有效载荷允许有零个或多个**扩展首部(extension header)**,再后面是数据部分。但请注意，所有的扩展首部并不属于IPv6数据报的首部。

![1505723240973](/pictures/networks/04/1505723240973.png)

![1505723261251](/pictures/networks/04/1505723261251.png)

### IPv6的地址

三种基本类型地址：**单播(unicast)、多播(multicast)、任播(anycast)**

![1505723408333](/pictures/networks/04/1505723408333.png)

![1505723454988](/pictures/networks/04/1505723454988.png)

### 从 IPv4 向 IPv6过渡

两种向IPv6过渡的策略，即使用**双协议栈**(dual stack)和使用**隧道技术**(tunneling)

### ICMPv6

![1505723647094](/pictures/networks/04/1505723647094.png)

![1505723667625](/pictures/networks/04/1505723667625.png)

## IP多播

![1505728093753](/pictures/networks/04/1505728093753.png)

## 虚拟专用网VPN和网络地址转换NAT

### 虚拟专用网VPN

仅在机构内部使用的计算机就可以由本机构**自行分配**其IP地址。这就是说，让这些计算机使用仅在本机构有效的IP地址(这种地址称为**本地地址**)，而不需要向互联网的管理机构申 请全球唯一的IP地址(这种地址称**为全球地址**)。

在互联网中的所有路由器，对目的地址是专用地址的数据报一律不进行转发。

2013年4月，RFC 6890全面地给出了所有特殊用途的IPv4地址，但三个专用地址块的指派并无变化：

* 10.0.0.0 到 10.255.255.255 (或记为10.0.0.0/8,它又称为 24 位块)
* 172.16.0.0 到 172.31.255.255    (或记为 172.16.0.0/12,它又称为 20 位块)
* 192.168.0.0 到 192.168.255.255 (或记为 192.168.0.0/16,它又称为 16 位块)

采用这样的专用IP地址的互连网络称为**专用互联网**或**本地互联网**，或更简单些，就叫做专用网。专用IP地址也叫做**可重用地址(reusable address)**。

利用公用的互联网作为本机构各 专用网之间的通信载体，这样的专用网又称为**虚拟专用网VPN (Virtual Private Network)**。

![1505732200237](/pictures/networks/04/1505732200237.png)

如图4-59(b)所示的、由场所A和B的内部网络所构成的虚拟专用网VPN又称**为内联网(intranet或intranet VPN，即内联网VPN)**，表不场所A和B都属于同一个机构。

还有一种类型的VPN,就是**远程接入VPN (remote access VPN)**。员工个人电脑中的VPN软件可以在员工的个人 电脑和公司的主机之间建立VPN隧道，因而外地员工与公司通信的内容也是保密的，员工们感到好像就是使用公司内部的本地网络。

### 网络地址转换NAT

**网络地址转换NAT (Network Address Translation)**方法是在1994年提出的。这种方法需要在专用网连接到互联网的路由器上安装NAT软件。装有NAT软件的路由器叫做NAT路由器，它**至少有一个**有效的外部全球IP地址。这样，所有使用本地地址的主机在和外界通信时，都要在NAT路由器上将其本地地址转换成全球IP地址，才能和互联网连接。

![1505732563322](/pictures/networks/04/1505732563322.png)

当NAT路由器具有n个全球IP地址时，专用网内最多可以同时有n台主机接入到互联网。这样就可以使专用网内较多数量的主机，轮流使用NAT路由器有限数量的全球IP地址。

为了更加有效地利用NAT路由器上的全球IP地址，现在常用的NAT转换表把运输层 的端口号也利用上。这样，就可以使多个拥有本地地址的主机，共用一个NAT路由器上的 全球IP地址，因而可以同时和互联网上的不同主机进行通信。

使用端口号的NAT也叫做**网络地址与端口号转换NAPT (Network Address and Port Translation)**,而不使用端口号的NAT就叫做**传统的NAT (traditional NAT)**。

## 多协议标记交换MPLS

MPLS具有以下三个方面的特点：(1)支持面向连接的服务质量。(2)支持流量工程， 平衡网络负载。(3)有效地支持虚拟专用网VPN。

MPLS在入口结点给每一个IP数据报打上固定长度的“标记”，然后根据标记在**第二层(链路层)**用硬件进行转发(在标记交换路由器中进行标记对换)，因而转发速率大大加快。

![1505733464837](/pictures/networks/04/1505733464837.png)

MPLS域(MPLS domain)是指该域中有许多彼此相邻的路由器，并且所有的路由器都是支持MPLS技术的标记交换路由器LSR (Label Switching Router)。LSR同时具有标记交换和路由选择这两种功能，标记交换功能是为了快速转发，但在这之前LSR需要使用路由选择功能构造转发表。